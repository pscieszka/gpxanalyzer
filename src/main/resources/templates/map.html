<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa z listą współrzędnych</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        #container {
            display: flex;
            justify-content: space-between;
            padding: 20px;
        }

        #info {
            width: 25%;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        #map {
            width: 70%;
            height: 300px;
            border-radius: 10px;
        }

        #scrollTableContainer {
            height: 400px;
            overflow-y: auto;
            margin-right: 20px;
            width: 40%
        }

        #paceTable {
            width: 100%;
            border-collapse: collapse;
        }

        #paceTable th, #paceTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        #paceTable th {
            background-color: #f4f4f4;
            position: sticky;
            top: 0;
        }

        #chartContainer {
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;

        }

        .chart {
            width: 60%;
            height: 400px;
            min-height: 300px;
            background-color: #f4f4f4;
            border-radius: 10px;
            padding: 10px;
        }

        .toggle-buttons {
            text-align: center;
            margin-top: 20px;
        }

        .toggle-buttons label {
            display: inline-flex;
            align-items: center;
            margin: 0 10px;
            cursor: pointer;
        }

        .toggle-slider {
            width: 50px;
            height: 24px;
            background-color: #ccc;
            border-radius: 50px;
            margin-left: 10px;
            position: relative;
            transition: background-color 0.3s;
        }

        .toggle-slider:before {
            content: "";
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: white;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        input[type="checkbox"] {
            display: none;
        }

        input[type="checkbox"]:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        input[type="checkbox"]:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
<div id="container">
    <div id="info">
        <h3>Info</h3>
        <p><strong>Time:</strong>  <span th:text="${totalTimeInString}"></span>
        <p><strong>Distance:</strong> <span th:text="${totalDistance} + ' km'"></span>
        <p><strong>Elevation gain:</strong> <span th:text="${elevationGain} + ' m'"></span></p>
        <p><strong>Heart Rate:</strong> <span th:text="${averageHeartRate} + ' bpm'"></span></p>
        <p><strong>Pace:</strong> <span th:text="${averagePace} + ' min/km'"></span></p>
        <p><strong>Gap pace:</strong> <span th:text="${averageGapPace} + ' min/km'"></span></p>
    </div>
    <div id="map"></div>
</div>

<div id="chartContainer">
    <div id="scrollTableContainer">
        <table id="paceTable">
            <thead>
            <tr>
                <th>Km</th>
                <th>Pace (min/km)</th>
                <th>Gap Pace (min/km)</th>
                <th>Elevation (m)</th>
                <th>Average HR (bmp)</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="chart">
        <canvas id="paceChart"></canvas>
    </div>
</div>

<div class="toggle-buttons">
    <label>
        Tempo (min/km)
        <input type="checkbox" id="togglePace" checked>
        <span class="toggle-slider"></span>
    </label>
    <label>
        Wysokość (m)
        <input type="checkbox" id="toggleElevation" checked>
        <span class="toggle-slider"></span>
    </label>
    <label>
        Tętno (bpm)
        <input type="checkbox" id="toggleHR">
        <span class="toggle-slider"></span>
    </label>
    <label>
        GAP Pace
        <input type="checkbox" id="toggleGapPace">
        <span class="toggle-slider"></span>
    </label>
    <label>
        MA10 PACE
        <input type="checkbox" id="toggleMAPace">
        <span class="toggle-slider"></span>
    </label>
    <label>
        MA10  gap PACE
        <input type="checkbox" id="toggleMAGapPace">
        <span class="toggle-slider"></span>
    </label>
</div>


<script>

    //info
    var averageElevationGainPerKm = [[${averageElevationGainPerKm}]];
    var pacePerKm = [[${pacePerKm}]];
    var gapPacePerKm = [[${gapPacePerKm}]];
    var hrPerKm = [[${heartRatePerKm}]];


    var coordinates = [[${coordinates}]];


    var map;
    var marker;
    var customIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div style="width: 12px; height: 12px; background-color: blue; border: 2px solid white; border-radius: 50%;"></div>',
        iconSize: [12, 12],
        iconAnchor: [6, 6]
    });

    if (coordinates && coordinates.length > 0) {
        map = L.map('map').setView([coordinates[0][0], coordinates[0][1]], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var latlngs = coordinates.map(function(coord) {
            return [coord[0], coord[1]];
        });

        L.polyline(latlngs, { color: 'red' }).addTo(map);
        map.fitBounds(latlngs);
        marker = L.marker([coordinates[0][0], coordinates[0][1]], { icon: customIcon }).addTo(map);
    }

    var totalDistance = ("[[${totalDistance}]]").replace(',', '.');
    totalDistance = parseFloat(totalDistance);
    var totalDistanceFloat = parseFloat(totalDistance);

    var fullKilometers = Math.floor(totalDistanceFloat);
    var remainingDistance = totalDistanceFloat - fullKilometers;


    function convertSecondsToTimeFormat(seconds) {
        var minutes = Math.floor(seconds / 60);
        var remainingSeconds = seconds % 60;
        return minutes + ':' + (remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds);
    }

    var tableBody = document.querySelector('#paceTable tbody');
    tableBody.innerHTML = '';

    pacePerKm.forEach(function(pace, index) {
        var row = document.createElement('tr');

        var kmCell = document.createElement('td');
        var paceCell = document.createElement('td');
        var gapPaceCell = document.createElement('td');
        var elevationCell = document.createElement('td');
        var hrCell = document.createElement('td');

        kmCell.textContent = index + 1;
        paceCell.textContent = convertSecondsToTimeFormat(pace);
        gapPaceCell.textContent = convertSecondsToTimeFormat(gapPacePerKm[index]);
        elevationCell.textContent = averageElevationGainPerKm[index];
        hrCell.textContent = hrPerKm[index];

        row.appendChild(kmCell);
        row.appendChild(paceCell);
        row.appendChild(gapPaceCell);
        row.appendChild(elevationCell);
        row.appendChild(hrCell);

        tableBody.appendChild(row);
    });

    // Jeśli jest pozostały fragment kilometra (np. 0.66), dodajemy go na końcu
    if (remainingDistance > 0) {
        var lastIndex = fullKilometers - 1;  // Indeks ostatniego pełnego kilometra

        var row = document.createElement('tr');

        var kmCell = document.createElement('td');
        var paceCell = document.createElement('td');
        var gapPaceCell = document.createElement('td');
        var elevationCell = document.createElement('td');
        var hrCell = document.createElement('td');

        kmCell.textContent = remainingDistance.toFixed(2);  // Ostatni fragment kilometra, np. 0.66
        paceCell.textContent = convertSecondsToTimeFormat(pacePerKm[lastIndex]);  // Tempo z ostatniego pełnego kilometra
        gapPaceCell.textContent = convertSecondsToTimeFormat(gapPacePerKm[lastIndex]);
        elevationCell.textContent = averageElevationGainPerKm[lastIndex];
        hrCell.textContent = hrPerKm[lastIndex];

        row.appendChild(kmCell);
        row.appendChild(paceCell);
        row.appendChild(gapPaceCell);
        row.appendChild(elevationCell);
        row.appendChild(hrCell);

        tableBody.appendChild(row);
    }

    function updateMarkerPosition(percentage) {
        var index = Math.floor((percentage / 100) * (coordinates.length - 1));
        var newPos = coordinates[index];
        marker.setLatLng(newPos);
    }

    var ctxPace = document.getElementById('paceChart').getContext('2d');
    var maxPace = Math.max(...paceData);
    var yMin = Math.floor(maxPace + 0.5);
    var elevationVisible = true;
    var hrVisible = false;
    var paceVisible = true;

    function formatTime(value) {
        var minutes = Math.floor(value);
        var seconds = Math.round((value - minutes) * 60);
        return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
    }

    var paceChart = new Chart(ctxPace, {
        type: 'line',
        data: {
            labels: Array.from({length: paceData.length}, (_, i) => (i + 1)),
            datasets: [
                {
                    label: 'Tempo (min/km)',
                    data: paceData,
                    borderColor: 'blue',
                    borderWidth: 1,
                    pointRadius: 0,
                    tension: 0.4,
                    yAxisID: 'paceAxis',
                    hidden: !paceVisible
                },
                {
                    label: 'Wysokość (m)',
                    data: elevationData,
                    backgroundColor: 'rgba(200, 200, 200, 0.5)',
                    borderWidth: 0,
                    type: 'line',
                    pointRadius: 0,
                    fill: true,
                    yAxisID: 'elevationAxis',
                    hidden: !elevationVisible
                },
                {
                    label: 'Tętno (bpm)',
                    data: heartRateData,
                    borderColor: 'red',
                    borderWidth: 1,
                    pointRadius: 0,
                    tension: 0.4,
                    yAxisID: 'hrAxis',
                    hidden: !hrVisible
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Dystans (km)'
                    },
                    ticks: {
                        callback: function(value, index, values) {
                            if (index % 40 === 0) {
                                return value / 40 + ' km';
                            }
                        }
                    }
                },
                paceAxis: {
                    reverse: true,
                    title: {
                        display: true,
                        text: 'Tempo (min/km)'
                    },
                    position: 'left',
                    grid: {
                        drawOnChartArea: false
                    },
                    type: 'logarithmic',
                },
                elevationAxis: {
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Wysokość (m)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                },
                hrAxis: {
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    enabled: true
                },
                legend: {
                    display: false
                }
            }
        }
    });
    paceChart.data.datasets.push({
        label: 'GAP Pace (min/km)',
        data: gapPace,
        reverse: true,
        borderColor: 'green',
        borderWidth: 1,
        pointRadius: 0,
        tension: 0.4,
        yAxisID: 'paceAxis',
        hidden: true
    });
    paceChart.data.datasets.push({
        label: 'MA10 PACE',
        data: MApace,
        reverse: true,
        borderColor: 'blue',
        borderWidth: 1,
        pointRadius: 0,
        tension: 0.4,
        yAxisID: 'paceAxis',
        hidden: true
    });
    paceChart.data.datasets.push({
        label: 'MA10  gap PACE',
        data: MAGapPace,
        reverse: true,
        borderColor: 'green',
        borderWidth: 1,
        pointRadius: 0,
        tension: 0.4,
        yAxisID: 'paceAxis',
        hidden: true
    });
    document.getElementById('toggleMAGapPace').addEventListener('change', function() {
        var MAGapPaceVisible = this.checked;
        paceChart.data.datasets[5].hidden = !MAGapPaceVisible;
        paceChart.update();
    });
    document.getElementById('toggleMAPace').addEventListener('change', function() {
        var MApaceVisible = this.checked;
        paceChart.data.datasets[4].hidden = !MApaceVisible;
        paceChart.update();
    });
    document.getElementById('toggleGapPace').addEventListener('change', function() {
        var gapPaceVisible = this.checked;
        paceChart.data.datasets[3].hidden = !gapPaceVisible;
        paceChart.update();
    });

    document.getElementById('toggleElevation').addEventListener('change', function() {
        elevationVisible = this.checked;
        paceChart.data.datasets[1].hidden = !elevationVisible;
        paceChart.update();
    });

    document.getElementById('toggleHR').checked = false;
    document.getElementById('toggleHR').addEventListener('change', function() {
        hrVisible = this.checked;
        paceChart.data.datasets[2].hidden = !hrVisible;
        paceChart.update();
    });

    document.getElementById('togglePace').addEventListener('change', function() {
        paceVisible = this.checked;
        paceChart.data.datasets[0].hidden = !paceVisible;
        paceChart.update();
    });

</script>
</script>

</body>
</html>
